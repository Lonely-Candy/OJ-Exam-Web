<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <title>题目列表</title>
    <link rel="icon" th:href="@{/favicon.ico}">

    <link th:href="@{/hAdmin/css/bootstrap.min.css?v=3.3.6}" rel="stylesheet">
    <link th:href="@{/hAdmin/css/font-awesome.css?v=4.4.0}" rel="stylesheet">
    <link th:href="@{/hAdmin/css/animate.css}" rel="stylesheet">
    <link th:href="@{/hAdmin/css/style.css?v=4.1.0}" rel="stylesheet">
    <!-- Sweet Alert -->
    <link th:href="@{/hAdmin/css/plugins/sweetalert/sweetalert.css}" rel="stylesheet">
    <!-- highlight -->
    <link th:href="@{/highlight/default.min.css}" rel="stylesheet">
    <link th:href="@{/hAdmin/css/plugins/iCheck/custom.css}" rel="stylesheet">

    <style>
        .inline-style {
            display: inline-flex;
        }

        .problem-score {
            background-color: #e1e7ee;
            display: flex;
            align-items: center;
            text-align: center;
        }

        .problem_text {
            font-family: 'Harmony', ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";;
            font-size: 1.5rem;
            font-weight: 400;
        }

        .input-answer {
            max-width: none;
            width: 19.2ch;
            max-height: 500px;
            display: inline-flex;
            margin: 0;
        }

        .input-answer-addon {
            min-width: 60px;
            align-items: center;
            text-align: center;
            background-color: #e1e7ee;
            padding: 6px 12px !important;
        }

        .problem-title {
            display: block;
            /*设置宽度*/
            width: 400px;
            /*若文字长度超过width，则隐藏文字*/
            overflow: hidden;
            /*超过的部分用 ... 显示*/
            text-overflow: ellipsis;
            /*取消文字自动换行，如果不加则文字会自动换行使得高度改变*/
            white-space: nowrap;
        }

        .hide-title {
            display: block;
            /*设置宽度*/
            width: 250px;
            /*若文字长度超过width，则隐藏文字*/
            overflow: hidden;
            /*超过的部分用 ... 显示*/
            text-overflow: ellipsis;
            /*取消文字自动换行，如果不加则文字会自动换行使得高度改变*/
            white-space: nowrap;
        }

        .table-hide {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        #problem_content {
            font-size: 15px;
        }
    </style>
</head>

<body class="gray-bg">
<div class="wrapper wrapper-content">
    <div class="row">
        <div class="col-sm-3">
            <div class="ibox float-e-margins">
                <div class="ibox-content">
                    <div class="file-manager">
                        <h3>题目列表</h3>
                        <!-- 填空题题目导航 -->
                        <h5 class="tag-title">填空题</h5>
                        <ul class="tag-list" style="padding: 0">
                            <li th:each="problem, problemStat:${completionProblems}">
                                <a th:onclick="'loadProblemData(' + ${problemStat.count - 1} + ', \'completion\')'">
                                    [[${problemStat.count}]]
                                </a>
                            </li>
                        </ul>
                        <div class="clearfix"></div>
                        <div class="hr-line-dashed"></div>
                        <!-- 编程填空题题目导航 -->
                        <h5 class="tag-title">编程填空题</h5>
                        <ul class="tag-list" style="padding: 0">
                            <li th:each="problem, problemStat:${programmeProblems}">
                                <a th:onclick="'loadProblemData(' + ${problemStat.count - 1} + ', \'programme\')'">
                                    [[${problemStat.count}]]
                                </a>
                            </li>
                        </ul>
                        <div class="clearfix"></div>
                        <div class="hr-line-dashed"></div>
                        <button onclick="submitExam()" class="btn btn-info btn-block" type="button">提交考试</button>
                        <div class="hr-line-dashed"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-9 animated fadeInRight">
            <div class="row">
                <div class="col-sm-12">
                    <!-- 详细内容展示 -->
                    <!-- 引入考试相关导航 -->
                    <div th:replace="~{navigation/examNav :: examNav('problemlist', ${examId})}"></div>
                    <!-- 题目列表 -->
                    <!-- 具体内容 -->
                    <div class="col">
                        <div class="tab-content">
                            <div class="ibox float-e-margins">
                                <div class="ibox-title">
                                    <h5><strong id="problem_id"></strong></h5>
                                    <div class="ibox-tools">
                                        <span id="problem_author" class="label label-primary"></span>
                                        <span id="problem_totalPoints"
                                              class="badge badge-success pull-right"></span>
                                    </div>
                                </div>
                                <div class="ibox-content">
                                    <div class="feed-activity-list">
                                        <div class="feed-element">
                                            <div class="media-body ">
                                                <div id="problem_content"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 全局js -->
<script th:src="@{/hAdmin/js/jquery.min.js?v=2.1.4}"></script>
<script th:src="@{/hAdmin/js/bootstrap.min.js?v=3.3.6}"></script>
<script th:src="@{/hAdmin/js/plugins/slimscroll/jquery.slimscroll.min.js}"></script>
<!-- Sweet alert -->
<script th:src="@{/hAdmin/js/plugins/sweetalert/sweetalert.min.js}"></script>
<!-- 自定义js -->
<script th:src="@{/hAdmin/js/content.js?v=1.0.0}"></script>
<!-- wangEditor -->
<script type="text/javascript" th:src="@{/webjars/wangeditor/4.7.5/dist/wangEditor.min.js}"></script>
<!-- highlight -->
<script type="text/javascript" th:src="@{/highlight/highlight.min.js}"></script>
<script>
    $(function () {
        $('.full-height-scroll').slimScroll({
            height: '100%'
        });
    });
</script>
<script th:inline="javascript">
    // 题目数据
    let completionProblems = [[${completionProblems}]];
    let programmeProblems = [[${programmeProblems}]];

    /**
     * 加载题目数据
     * @param index 题号
     * @param type 题目类型
     */
    let loadProblemData = function (index, type) {
        let proId = "#problem_id";
        let proAuthor = "#problem_author";
        let proContent = "#problem_content";
        let proTotalPoints = "#problem_totalPoints";
        let problemData = type == "completion" ? completionProblems : programmeProblems;
        // 设置显示内容
        $(proId).text(type.charAt(0).toUpperCase() + "-" + (index + 1));
        $(proAuthor).text("出题人: " + problemData[index].adminid);
        $(proContent).html(problemData[index].replaceContextNoAnswer);
        $(proTotalPoints).text("分数: " + problemData[index].totalPoints);
        // 设置保存的答案
        let answerArray = getLocalAnswerArray(index, type);
        // 给input输入框添加 onchange 事件
        let inputs = $("#problem_content").find(".input-answer").find("input");
        for (let i = 0; i < inputs.length; i++) {
            $(inputs[i]).attr("onchange", 'inputOnchange(' + index + ', this, \'' + type + '\')').val(answerArray[i]);
        }
    }

    /**
     * 提交考试
     */
    const submitExam = function () {
        let completionAnswers = new Array();
        let programmeAnswers = new Array();
        // 获取所有的答案
        for (let i = 0; i < completionProblems.length; i++) {
            let answer = getLocalAnswerArray(i, "completion");
            completionAnswers.push(answer);
        }
        for (let i = 0; i < programmeProblems.length; i++) {
            let answer = getLocalAnswerArray(i, "programme");
            programmeAnswers.push(answer);
        }
        console.log(completionAnswers);
        console.log(programmeAnswers);
        let submitData = {
            "examId": [[${examId}]],
            "completionAnswers": completionAnswers,
            "programmeAnswers": programmeAnswers
        }
        $.ajax({
            type: 'post',
            headers: {
                "Accept": "application/json",
                "Content-Type": "application/json"
            },
            url: "/student/submitExam",
            success: function (data, status) {
                if (status) {
                    if (data.code == 777) {
                        swal({title: "提交成功", type: "success"}, function () {
                            history.go(-1);
                        })
                    } else {
                        swal("提交失败", data.message, 'warning');
                    }
                } else {
                    swal("服务器异常", "请联系管理员", "error");
                }
            },
            data: JSON.stringify(submitData)
        });
    }

    /**
     * 答案输入保存
     */
    const inputOnchange = function (index, e, type) {
        let answerArray = getLocalAnswerArray(index, type);
        let idSuffix = $(e).parents("span")[0].id.split("_")[2];
        let answerName = type == "completion" ? "cAnswers_" + index : "pAnswers_" + index;
        answerArray[parseInt(idSuffix)] = $(e).val();
        sessionStorage.setItem(answerName, JSON.stringify(answerArray));
    }

    /**
     * 获取保存在本地的答案
     */
    const getLocalAnswerArray = function (index, type) {
        let answerName;
        let problems;
        if (type == "completion") {
            answerName = "cAnswers_" + index;
            problems = completionProblems;
        } else if (type == "programme") {
            answerName = "pAnswers_" + index;
            problems = programmeProblems;
        }
        let answerArray = JSON.parse(sessionStorage.getItem(answerName));
        if (answerArray == null) {
            answerArray = new Array(problems[index].blankSum);
        }
        return answerArray;
    }

    /**
     * 页面加载完毕后初始化文本编辑器和题目显示
     */
    $(document).ready(function () {
        loadProblemData(0, "completion");
    });
</script>
</body>
</html>