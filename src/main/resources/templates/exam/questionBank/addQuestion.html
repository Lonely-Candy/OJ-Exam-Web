<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>添加题目</title>

    <link th:href="@{/hAdmin/css/bootstrap.min.css?v=3.3.6}" rel="stylesheet">
    <link th:href="@{/hAdmin/css/font-awesome.css?v=4.4.0}" rel="stylesheet">
    <link th:href="@{/hAdmin/css/animate.css}" rel="stylesheet">
    <link rel="stylesheet" type="text/css" th:href="@{/hAdmin/css/plugins/simditor/simditor.css}"/>
    <link th:href="@{/hAdmin/css/style.css?v=4.1.0}" rel="stylesheet">
    <!-- Sweet Alert -->
    <link th:href="@{/hAdmin/css/plugins/sweetalert/sweetalert.css}" rel="stylesheet">

    <style>
        .simditor-toolbar {
            width: 100% !important;
        }

        .score_style {
            width: 65px;
            display: initial;
        }
    </style>
</head>

<body class="gray-bg">
<div class="wrapper wrapper-content">
    <!-- 题型导航 -->
    <ul class="nav nav-tabs">
        <li class="active">
            <a data-toggle="tab" href="#problem-1" aria-expanded="true">添加填空题</a>
        </li>
        <li class="">
            <a data-toggle="tab" href="#problem-2" aria-expanded="false">添加编程填空题</a>
        </li>
    </ul>
    <!-- 题目参数表单 -->
    <div class="tab-content">
        <!-- 填空题 -->
        <div id="problem-1" class="tab-pane active">
            <div class="panel-body">
                <!-- 题目标题 -->
                <div class="row">
                    <div class="col-sm-12">
                        <div class="ibox float-e-margins">
                            <div class="ibox-title">
                                <h5>题目标题</h5>
                            </div>
                            <div class="ibox-content">
                                <!-- 题目标题 -->
                                <input id="title_completion" placeholder="填写标题，可略，不填写将显示部分题目" type="text"
                                       class="form-control">
                            </div>
                        </div>
                    </div>
                </div>
                <!-- 题目内容 -->
                <div class="row">
                    <div class="col-sm-12">
                        <div class="ibox float-e-margins">
                            <div class="ibox-title">
                                <h5>题目内容</h5>
                                <div class="ibox-tools">
                                    <button id="save" class="btn btn-primary btn-xs" onclick="preview('completion')"
                                            type="button">保存
                                    </button>
                                </div>
                            </div>
                            <div id="completion_text" class="ibox-content">
                                <!-- 题目内容 -->
                                <textarea id="editor_completion" placeholder="这里输入内容" autofocus>
                                    <p>这是填空题模板。</p>
                                    <p>例题：Java把数据类型分为<u>数据类型</u>和<u>引用数据类型</u>。</p>
                                    <ul>
                                        <li>每题可以有多个空。</li>
                                        <li>将完整的题目内容复制到文本框中，在需要填空的答案选中后，添加下划线，会自动添加到下方分数设置中。</li>
                                        <li>题目创建后不可修改填空数量。</li>
                                        <li>题目设置完成后，请先点击保存。</li>
                                    </ul>
                                </textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- 填空分数 -->
                <div class="row">
                    <div class="col-sm-12">
                        <div class="ibox">
                            <div class="ibox-title">
                                <h5>填空分值设置</h5>
                            </div>
                            <div class="ibox-content">
                                <div id="score_completions" class="row">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- 提交按钮 -->
                <div class="row">
                    <div class="col-sm-12">
                        <button onclick="submit('completion')" type="button" class="btn btn-success pull-right">添加
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- 编程填空题 -->
        <div id="problem-2" class="tab-pane">
            <div class="panel-body">
                <!-- 题目标题 -->
                <div class="row">
                    <div class="col-sm-12">
                        <div class="ibox float-e-margins">
                            <div class="ibox-title">
                                <h5>题目标题</h5>
                            </div>
                            <div class="ibox-content">
                                <!-- 题目标题 -->
                                <input placeholder="填写标题，可略，不填写将显示部分题目" type="text" class="form-control">
                            </div>
                        </div>
                    </div>
                </div>
                <!-- 题目内容 -->
                <div class="row">
                    <div class="col-sm-12">
                        <div class="ibox float-e-margins">
                            <div class="ibox-title">
                                <h5>题目内容</h5>
                            </div>
                            <div class="ibox-content">
                                <!-- 题目内容 -->
                                <textarea id="editor_programme" placeholder="这里输入内容" autofocus>
                                    <p>Simditor 是团队协作工具 <a href="http://tower.im" target="_blank">Tower</a> 使用的富文本编辑器。</p>
                                    <p>相比传统的编辑器它的特点是：</p>
                                    <ul>
                                        <li>功能精简，<u>加载快速</u></li>
                                        <li>输出格式化的标准 HTML</li>
                                        <li>每一个功能都有非常优秀的使用体验</li>
                                    </ul>
                                    <p>兼容的浏览器：IE10+、Chrome、Firefox、Safari。</p>
                                </textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- 填空分数 -->
                <div class="row">
                    <div class="col-sm-12">
                        <div class="ibox">
                            <div class="ibox-title">
                                <h5>填空分值设置</h5>
                            </div>
                            <div class="ibox-content">

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 全局js -->
<script th:src="@{/hAdmin/js/jquery.min.js?v=2.1.4}"></script>
<script th:src="@{/hAdmin/js/bootstrap.min.js?v=3.3.6}"></script>
<!-- 自定义js -->
<script th:src="@{/hAdmin/js/content.js?v=1.0.0}"></script>
<!-- simditor -->
<script type="text/javascript" th:src="@{/hAdmin/js/plugins/simditor/module.js}"></script>
<script type="text/javascript" th:src="@{/hAdmin/js/plugins/simditor/uploader.js}"></script>
<script type="text/javascript" th:src="@{/hAdmin/js/plugins/simditor/hotkeys.js}"></script>
<script type="text/javascript" th:src="@{/hAdmin/js/plugins/simditor/simditor.js}"></script>
<!-- Sweet alert -->
<script th:src="@{/hAdmin/js/plugins/sweetalert/sweetalert.min.js}"></script>
<script>
    // 填空题文本编辑器
    var editor_completion;
    // 程序填空题文本编辑器
    var editor_programme;
    // 填空题对应的内容
    var completion_value;
    // 填空题对应的填空答案
    var completion_uElements;

    /**
     * 页面加载完毕后，创建文本编辑器
     */
    $(document).ready(function () {
        /* 填空题文本编辑 */
        editor_completion = new Simditor({
            textarea: $('#editor_completion'),
        });
        /* 编程填空文本编辑 */
        editor_programme = new Simditor({
            textarea: $('#editor_programme'),
        });
    });

    /**
     * 点击 保存/修改 按钮后点击方法
     * 自动识别下划线为填空部分
     * @param type 区分填空和编程填空标记
     */
    var preview = function (type) {
        /* 填空题 */
        if (type == "completion") {
            if (editor_completion != null) {
                /* 填空题保存 */
                completion_value = editor_completion.getValue();
                editor_completion.destroy();
                editor_completion = null;
                $('#completion_text').html(completion_value);
                $('#save').text('修改');
                /* 自动生成填空分值设置 */
                completion_uElements = $(completion_value).find('u');
                var score_completions_html = "";
                for (var i = 0; i < completion_uElements.length; i++) {
                    score_completions_html += '<div class="col-sm-4"><div class="panel panel-primary">';
                    score_completions_html += '<div class="panel-heading">填空 ' + (i + 1) + '</div>';
                    score_completions_html += '<div class="panel-body"><div class="col-md-8">' +
                        '<input type="text" value="' + $(completion_uElements[i]).text() + '" disabled id="content_' + (i + 1) + '" class="form-control"></div>' +
                        '<div class="col-md-4"><input type="text" id="score_' + (i + 1) + '" class="score_style form-control"> 分</div></div></div></div>';
                }
                $("#score_completions").html(score_completions_html);
            } else {
                /* 填空题修改 */
                var value = $('#completion_text').html();
                $('#completion_text').html('<textarea id="editor_completion" placeholder="这里输入内容" autofocus>' + value + '</textarea>');
                editor_completion = new Simditor({
                    textarea: $('#editor_completion'),
                })
                $('#save').text('保存');
                $('#score_completions').html('');
                completion_uElements = null;
                completion_value = null;
            }
        }
        /* 编程填空题 */
        /* 编程填空文本值监听 */
        // editor_programme.on('valuechanged', function (e) {
        //     var value = editor_programme.getValue();
        //     var uElements = $(value).find('u');
        //     for (var i = 0; i < uElements.length; i++) {
        //         console.log($(uElements[i]).text());
        //     }
        // });
    };

    /**
     * 点击 添加 按钮后点击方法
     * @param type 区分填空和编程填空标记
     */
    var submit = function (type) {
        if (type == 'completion' && completion_uElements != null
                && completion_value != null) {
            /* 类型：填空 */
            /* 获取题目参数 */
            // 1. 题目标题
            var title = $('#title_completion').val();
            // 获取填空数
            var completionNum = completion_uElements.length;
            // 2. 填空对应答案
            var answers = new Array(completionNum);
            // 获取填空答案
            for (var i = 0; i < completionNum; i++) {
                answers[i] = new String($(completion_uElements[i]).text());
            }
            // 3. 填空对应分数
            var scores = new Array(completion_uElements.length);
            // 获取填空分数
            for (var i = 0; i < completion_uElements.length; i++) {
                scores[i] = parseInt($('#score_' + (i + 1)).val());
            }
            // 4. 发送请求
            $.post("/addCompletion", {
                "title": title,
                "contentHtml": completion_value,
                "scores": scores.toString(),
                "answers": answers.toString()
            }, function (data, status) {
                if(status == 'success') {
                    if(data.code == 777) {
                        swal({
                            title: "添加成功",
                            type: "success"
                        }, function () {
                            history.go(0);
                        });
                    } else {
                        if(data.code == 666) {
                            swal({
                                title: "添加失败",
                                text: "数据库添加失败",
                                type: "warning",
                            });
                        }
                    }
                }
            })
        }
    }
</script>
</body>
</html>